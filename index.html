<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantum Finances | Tabbed Pro v6</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        darkBg: '#020617',
                        lightBg: '#f1f5f9',
                        accent: '#6366f1'
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; transition: background-color 0.3s; }
        
        #three-canvas {
            position: fixed; top: 0; left: 0; z-index: -1; width: 100%; height: 100%;
            pointer-events: none; transition: opacity 0.5s;
        }

        /* Remarcado de bordes agresivo */
        .card-container {
            border: 2px solid transparent;
            transition: all 0.2s ease-in-out;
        }
        .light .card-container { border-color: #94a3b8; background: #ffffff; }
        .dark .card-container { border-color: #334155; background: rgba(15, 23, 42, 0.85); }

        /* Estilo Garantizado para Selects */
        select, input {
            background-color: transparent;
            border-width: 2px;
            outline: none;
        }
        .light select, .light input { border-color: #cbd5e1; color: #0f172a; background-color: #ffffff; }
        .dark select, .dark input { border-color: #334155; color: #f8fafc; background-color: #1e293b; }
        
        select option {
            background-color: #fff; color: #000;
        }
        .dark select option {
            background-color: #1e293b; color: #fff;
        }

        .glass { backdrop-filter: blur(16px); }
        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-lightBg dark:bg-darkBg text-slate-900 dark:text-slate-100 min-h-screen">

    <div id="three-canvas"></div>

    <!-- Navegación con TABS -->
    <nav class="sticky top-0 z-40 glass border-b-2 border-slate-400 dark:border-white/10 px-4 py-3">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-2">
                <div class="bg-accent p-1.5 rounded-lg text-white"><i data-lucide="zap"></i></div>
                <h1 class="text-lg font-extrabold tracking-tight">QUANTUM <span class="text-accent text-xs">V6</span></h1>
            </div>
            
            <div class="flex bg-slate-200 dark:bg-slate-800 p-1 rounded-xl border-2 border-slate-300 dark:border-slate-700">
                <button onclick="switchTab('dashboard')" id="btn-dashboard" class="px-6 py-2 rounded-lg text-sm font-bold transition-all active-tab bg-accent text-white">Registrar</button>
                <button onclick="switchTab('reports')" id="btn-reports" class="px-6 py-2 rounded-lg text-sm font-bold transition-all text-slate-500">Consolidado</button>
            </div>

            <div class="flex items-center gap-2">
                <button id="themeToggle" class="p-2 border-2 border-slate-300 dark:border-slate-700 rounded-xl hover:bg-accent hover:text-white transition"><i data-lucide="sun" id="themeIcon" class="w-4 h-4"></i></button>
                <button id="settingsToggle" class="p-2 border-2 border-slate-300 dark:border-slate-700 rounded-xl hover:bg-accent hover:text-white transition"><i data-lucide="settings" class="w-4 h-4"></i></button>
            </div>
        </div>
    </nav>

    <!-- Modal Ajustes -->
    <div id="settingsModal" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/80 hidden backdrop-blur-md px-4">
        <div class="card-container glass p-6 rounded-3xl max-w-sm w-full shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold flex items-center gap-2"><i data-lucide="sliders"></i> Ajustes</h2>
                <button onclick="toggleModal()"><i data-lucide="x"></i></button>
            </div>
            <div class="space-y-6">
                <div class="flex justify-between items-center bg-slate-100 dark:bg-slate-800 p-4 rounded-2xl border-2 border-slate-300 dark:border-slate-700">
                    <span class="font-bold text-sm">Fondo Animado</span>
                    <button id="animToggle" class="w-12 h-6 rounded-full bg-slate-400 relative transition-all duration-300">
                        <div id="animDot" class="w-4 h-4 bg-white rounded-full absolute top-1 left-1 transition-all"></div>
                    </button>
                </div>
                <div class="grid grid-cols-1 gap-2 text-sm">
                    <button onclick="exportData()" class="bg-accent text-white font-black py-3 rounded-xl shadow-lg">Exportar Copia JSON</button>
                    <label class="border-2 border-accent text-accent font-black py-3 rounded-xl text-center cursor-pointer hover:bg-accent hover:text-white transition">
                        Importar Copia <input type="file" id="importFile" class="hidden">
                    </label>
                </div>
            </div>
        </div>
    </div>

    <main class="max-w-7xl mx-auto px-4 py-6">
        
        <!-- TAB: DASHBOARD (REGISTRAR) -->
        <section id="tab-dashboard" class="tab-content active">
            <!-- Metrics Summary -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
                <div class="card-container p-5 rounded-3xl border-b-4 border-b-accent">
                    <p class="text-slate-500 text-[10px] font-black uppercase">Saldo General</p>
                    <h2 id="totalBalance" class="text-3xl font-black mt-1">$0.00</h2>
                </div>
                <div class="card-container p-5 rounded-3xl border-b-4 border-b-emerald-500">
                    <p class="text-slate-500 text-[10px] font-black uppercase">Total Ingresos</p>
                    <h2 id="totalIncomes" class="text-3xl font-black mt-1 text-emerald-500">+$0.00</h2>
                </div>
                <div class="card-container p-5 rounded-3xl border-b-4 border-b-rose-500">
                    <p class="text-slate-500 text-[10px] font-black uppercase">Total Gastos</p>
                    <h2 id="totalExpenses" class="text-3xl font-black mt-1 text-rose-500">-$0.00</h2>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                <!-- Registro Form -->
                <div class="lg:col-span-4">
                    <div class="card-container p-6 rounded-3xl">
                        <h3 class="font-bold mb-4 text-accent italic uppercase text-xs tracking-widest"><i data-lucide="plus-circle" class="inline w-4 h-4 mr-1"></i> Nueva Operación</h3>
                        <form id="financeForm" class="space-y-4">
                            <input type="hidden" id="editId">
                            <input type="text" id="desc" placeholder="Concepto (Ejem: Alquiler)" class="w-full rounded-xl p-3" required>
                            <div class="grid grid-cols-2 gap-3">
                                <input type="number" id="amount" placeholder="0.00" step="0.01" class="w-full rounded-xl p-3" required>
                                <select id="type" class="w-full rounded-xl p-3">
                                    <option value="expense">GASTO</option>
                                    <option value="income">INGRESO</option>
                                </select>
                            </div>
                            <input type="date" id="date" class="w-full rounded-xl p-3" required>
                            <select id="category" class="w-full rounded-xl p-3">
                                <option value="Comida">Comida</option>
                                <option value="Vivienda">Vivienda</option>
                                <option value="Ocio">Ocio</option>
                                <option value="Sueldo">Sueldo</option>
                                <option value="Transporte">Transporte</option>
                                <option value="Otros">Otros</option>
                            </select>
                            <button type="submit" id="submitBtn" class="w-full bg-accent text-white font-black py-4 rounded-2xl shadow-xl hover:scale-[1.01] active:scale-95 transition-all">GUARDAR REGISTRO</button>
                        </form>
                    </div>
                </div>

                <!-- Historial List -->
                <div class="lg:col-span-8">
                    <div class="card-container rounded-3xl overflow-hidden flex flex-col min-h-[500px]">
                        <div class="p-5 border-b-2 border-slate-200 dark:border-slate-800 flex justify-between items-center bg-slate-50/50 dark:bg-slate-900/50">
                            <span class="font-black text-xs uppercase tracking-widest italic">Movimientos Recientes</span>
                            <div class="flex gap-2">
                                <select id="yearFilter" class="rounded-lg px-2 py-1 text-[10px] font-bold"></select>
                                <select id="monthFilter" class="rounded-lg px-2 py-1 text-[10px] font-bold"></select>
                            </div>
                        </div>
                        <div id="transactionList" class="flex-1 overflow-y-auto custom-scrollbar divide-y-2 divide-slate-100 dark:divide-slate-800"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- TAB: REPORTS (CONSOLIDADO) -->
        <section id="tab-reports" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <!-- Tabla Mensual -->
                <div class="lg:col-span-8">
                    <div class="card-container p-6 rounded-3xl">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="font-bold text-accent italic"><i data-lucide="calendar" class="inline w-5 h-5 mr-1"></i> Desglose Mensual</h3>
                            <select id="consolidatedYearFilter" class="rounded-xl px-4 py-2 text-sm font-bold border-2"></select>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm">
                                <thead class="border-b-2 border-slate-200 dark:border-slate-800">
                                    <tr class="text-slate-400 font-black">
                                        <th class="p-4">MES</th>
                                        <th class="p-4">INGRESOS</th>
                                        <th class="p-4">GASTOS</th>
                                        <th class="p-4">RESULTADO</th>
                                    </tr>
                                </thead>
                                <tbody id="monthlyReportBody" class="divide-y divide-slate-100 dark:divide-slate-800">
                                    <!-- Dinámico -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Resumen Categorías y Años -->
                <div class="lg:col-span-4 space-y-6">
                    <div class="card-container p-6 rounded-3xl">
                        <h3 class="text-center text-[10px] font-black mb-4 uppercase tracking-widest italic">Gastos por Categoría</h3>
                        <div class="h-48 relative"><canvas id="categoryChart"></canvas></div>
                    </div>
                    <div class="card-container p-6 rounded-3xl">
                        <h3 class="font-bold text-xs uppercase mb-4 tracking-tighter italic">Histórico Anual</h3>
                        <div id="yearlySummaryBody" class="space-y-3 text-xs"></div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <script>
        // --- ESTADO ---
        let transactions = JSON.parse(localStorage.getItem('q_data_v6')) || [];
        let config = JSON.parse(localStorage.getItem('q_config_v6')) || { theme: 'dark', animation: true, lastTab: 'dashboard' };
        let myChart = null;
        let animationFrameId;
        const monthsNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

        // --- THREE.JS ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('three-canvas').appendChild(renderer.domElement);
        const geometry = new THREE.PlaneGeometry(60, 60, 30, 30);
        const material = new THREE.MeshBasicMaterial({ color: 0x6366f1, wireframe: true, transparent: true, opacity: 0.1 });
        const plane = new THREE.Mesh(geometry, material);
        plane.rotation.x = -Math.PI / 2.5;
        scene.add(plane); camera.position.z = 15;

        function animate() {
            if (!config.animation) return;
            animationFrameId = requestAnimationFrame(animate);
            const time = Date.now() * 0.0008;
            const pos = plane.geometry.attributes.position.array;
            for (let i = 0; i < pos.length; i += 3) pos[i + 2] = Math.sin(pos[i] * 0.2 + time) * 1.5;
            plane.geometry.attributes.position.needsUpdate = true;
            renderer.render(scene, camera);
        }

        // --- CORE UI ---
        function init() {
            applyTheme(); 
            applyAnimation(); 
            switchTab(config.lastTab);
            updateAllFilters();
            document.getElementById('date').valueAsDate = new Date();
            updateDashboard();
            updateReports();
            lucide.createIcons();
        }

        function switchTab(tabId) {
            config.lastTab = tabId;
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`tab-${tabId}`).classList.add('active');
            
            const btnD = document.getElementById('btn-dashboard');
            const btnR = document.getElementById('btn-reports');
            
            if(tabId === 'dashboard') {
                btnD.classList.add('bg-accent', 'text-white'); btnD.classList.remove('text-slate-500');
                btnR.classList.remove('bg-accent', 'text-white'); btnR.classList.add('text-slate-500');
                updateDashboard();
            } else {
                btnR.classList.add('bg-accent', 'text-white'); btnR.classList.remove('text-slate-500');
                btnD.classList.remove('bg-accent', 'text-white'); btnD.classList.add('text-slate-500');
                updateReports();
            }
            saveConfig();
        }

        function updateAllFilters() {
            const years = [...new Set(transactions.map(t => t.date.split('-')[0]))];
            const nowY = new Date().getFullYear();
            if (!years.includes(nowY.toString())) years.push(nowY.toString());
            years.sort((a,b) => b-a);

            const yHtml = years.map(y => `<option value="${y}">${y}</option>`).join('');
            document.getElementById('yearFilter').innerHTML = yHtml;
            document.getElementById('consolidatedYearFilter').innerHTML = yHtml;

            let mHtml = '<option value="all">Todos los meses</option>';
            monthsNames.forEach((m, i) => mHtml += `<option value="${String(i+1).padStart(2, '0')}">${m}</option>`);
            document.getElementById('monthFilter').innerHTML = mHtml;
            document.getElementById('monthFilter').value = String(new Date().getMonth()+1).padStart(2, '0');
        }

        // --- DASHBOARD LOGIC ---
        function updateDashboard() {
            const y = document.getElementById('yearFilter').value;
            const m = document.getElementById('monthFilter').value;
            const filtered = transactions.filter(t => t.date.startsWith(y) && (m === 'all' || t.date.split('-')[1] === m));
            
            let inc = 0, exp = 0;
            filtered.forEach(t => t.type === 'income' ? inc += t.amount : exp += t.amount);

            document.getElementById('totalBalance').innerText = `$${(inc - exp).toLocaleString()}`;
            document.getElementById('totalIncomes').innerText = `+$${inc.toLocaleString()}`;
            document.getElementById('totalExpenses').innerText = `-$${exp.toLocaleString()}`;

            const list = document.getElementById('transactionList');
            list.innerHTML = filtered.sort((a,b) => new Date(b.date) - new Date(a.date)).map(t => `
                <div class="p-4 flex justify-between items-center hover:bg-slate-400/5 group">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg flex items-center justify-center border-2 ${t.type === 'income' ? 'border-emerald-500/30 text-emerald-500' : 'border-rose-500/30 text-rose-500'}">
                            <i data-lucide="${t.type === 'income' ? 'arrow-up-right' : 'arrow-down-right'}" class="w-4 h-4"></i>
                        </div>
                        <div><p class="text-sm font-bold">${t.desc}</p><p class="text-[9px] font-black opacity-40">${t.category} | ${t.date}</p></div>
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="font-black text-sm ${t.type === 'income' ? 'text-emerald-500' : 'text-rose-500'}">${t.type === 'income' ? '+' : '-'}$${t.amount.toLocaleString()}</span>
                        <div class="flex opacity-0 group-hover:opacity-100 gap-2">
                            <button onclick="editItem(${t.id})"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                            <button onclick="deleteItem(${t.id})"><i data-lucide="trash" class="w-4 h-4 hover:text-rose-500"></i></button>
                        </div>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        // --- REPORTS LOGIC ---
        function updateReports() {
            const year = document.getElementById('consolidatedYearFilter').value;
            const tbody = document.getElementById('monthlyReportBody');
            const catData = {};
            let html = '';

            monthsNames.forEach((name, i) => {
                const mStr = String(i+1).padStart(2, '0');
                const mTransactions = transactions.filter(t => t.date.startsWith(`${year}-${mStr}`));
                let mInc = 0, mExp = 0;
                
                mTransactions.forEach(t => {
                    if(t.type === 'income') mInc += t.amount;
                    else { 
                        mExp += t.amount; 
                        catData[t.category] = (catData[t.category] || 0) + t.amount;
                    }
                });
                
                const bal = mInc - mExp;
                html += `
                    <tr class="hover:bg-slate-400/5 transition">
                        <td class="p-4 font-bold text-xs">${name}</td>
                        <td class="p-4 text-emerald-500">+$${mInc.toLocaleString()}</td>
                        <td class="p-4 text-rose-500">-$${mExp.toLocaleString()}</td>
                        <td class="p-4 font-black ${bal >=0 ? 'text-accent' : 'text-rose-600'}">$${bal.toLocaleString()}</td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;

            // Chart
            updateChart(catData);

            // Yearly History
            const yYears = [...new Set(transactions.map(t => t.date.split('-')[0]))].sort((a,b) => b-a);
            document.getElementById('yearlySummaryBody').innerHTML = yYears.map(y => {
                let yInc = 0, yExp = 0;
                transactions.filter(t => t.date.startsWith(y)).forEach(t => t.type === 'income' ? yInc += t.amount : yExp += t.amount);
                return `
                    <div class="p-3 bg-slate-400/5 rounded-xl border-2 border-slate-300 dark:border-slate-700">
                        <div class="flex justify-between font-black"><span>${y}</span> <span class="${yInc-yExp >=0 ? 'text-emerald-500' : 'text-rose-500'}">$${(yInc-yExp).toLocaleString()}</span></div>
                    </div>
                `;
            }).join('');
        }

        function updateChart(data) {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            if(myChart) myChart.destroy();
            if(Object.keys(data).length === 0) return;
            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        data: Object.values(data),
                        backgroundColor: ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'],
                        borderWidth: 2, borderColor: config.theme === 'dark' ? '#0f172a' : '#ffffff'
                    }]
                },
                options: { cutout: '75%', plugins: { legend: { display: false } }, maintainAspectRatio: false }
            });
        }

        // --- FORM & DATA ---
        document.getElementById('financeForm').addEventListener('submit', e => {
            e.preventDefault();
            const id = document.getElementById('editId').value;
            const data = {
                id: id ? parseInt(id) : Date.now(),
                desc: document.getElementById('desc').value,
                amount: parseFloat(document.getElementById('amount').value),
                date: document.getElementById('date').value,
                type: document.getElementById('type').value,
                category: document.getElementById('category').value
            };
            if(id) transactions = transactions.map(t => t.id == id ? data : t);
            else transactions.push(data);
            
            document.getElementById('financeForm').reset();
            document.getElementById('editId').value = "";
            document.getElementById('submitBtn').innerText = "GUARDAR REGISTRO";
            document.getElementById('date').valueAsDate = new Date();
            
            saveData();
            updateAllFilters();
            updateDashboard();
        });

        function editItem(id) {
            const t = transactions.find(x => x.id === id);
            document.getElementById('editId').value = t.id;
            document.getElementById('desc').value = t.desc;
            document.getElementById('amount').value = t.amount;
            document.getElementById('date').value = t.date;
            document.getElementById('type').value = t.type;
            document.getElementById('category').value = t.category;
            document.getElementById('submitBtn').innerText = "ACTUALIZAR DATOS";
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function deleteItem(id) {
            if(confirm('¿Eliminar definitivamente?')) {
                transactions = transactions.filter(t => t.id !== id);
                saveData();
                updateAllFilters();
                updateDashboard();
            }
        }

        // --- HELPERS ---
        function applyTheme() {
            const h = document.documentElement;
            if(config.theme === 'dark') { h.classList.add('dark'); h.classList.remove('light'); }
            else { h.classList.add('light'); h.classList.remove('dark'); }
            document.getElementById('themeIcon').setAttribute('data-lucide', config.theme === 'dark' ? 'sun' : 'moon');
            lucide.createIcons();
        }

        function applyAnimation() {
            const dot = document.getElementById('animDot');
            if(config.animation) { dot.style.left = '28px'; animate(); }
            else { dot.style.left = '4px'; cancelAnimationFrame(animationFrameId); }
        }

        function saveData() { localStorage.setItem('q_data_v6', JSON.stringify(transactions)); }
        function saveConfig() { localStorage.setItem('q_config_v6', JSON.stringify(config)); }
        function toggleModal() { document.getElementById('settingsModal').classList.toggle('hidden'); }

        document.getElementById('themeToggle').addEventListener('click', () => { config.theme = config.theme === 'dark' ? 'light' : 'dark'; applyTheme(); saveConfig(); });
        document.getElementById('animToggle').addEventListener('click', () => { config.animation = !config.animation; applyAnimation(); saveConfig(); location.reload(); });
        document.getElementById('settingsToggle').addEventListener('click', toggleModal);
        document.getElementById('yearFilter').addEventListener('change', updateDashboard);
        document.getElementById('monthFilter').addEventListener('change', updateDashboard);
        document.getElementById('consolidatedYearFilter').addEventListener('change', updateReports);

        function exportData() {
            const b = new Blob([JSON.stringify(transactions, null, 2)], {type: 'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'quantum_backup.json'; a.click();
        }

        document.getElementById('importFile').addEventListener('change', e => {
            const r = new FileReader();
            r.onload = ev => { transactions = JSON.parse(ev.target.result); saveData(); updateAllFilters(); updateDashboard(); alert('Importado'); };
            r.readAsText(e.target.files[0]);
        });

        window.addEventListener('resize', () => { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });

        init();
    </script>
</body>
</html>